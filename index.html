<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Facial Expression Detection</title>
    <!-- Load required scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.4.4/dist/face-landmarks-detection.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-expression-recognition@0.3.0/dist/face-expression-recognition.min.js"></script>
  </head>
  <body>
    <h1>Facial Expression Detection</h1>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <p id="expression">No expression detected</p>
    <script>
      // Initialize face-api.js models
      Promise.all([
        faceLandmarksDetection.load(
          faceLandmarksDetection.SupportedPackages.mediapipeFacemesh
        ),
        faceExpressionRecognition.load(
          faceExpressionRecognition.SupportedPackages.tfjs
        ),
      ]).then(([faceLandmarksModel, faceExpressionModel]) => {
        // Get video stream and set it as source for video element
        navigator.mediaDevices.getUserMedia({ video: true }).then((stream) => {
          const video = document.getElementById("video");
          video.srcObject = stream;
          video.play();
        });

        // Get canvas element and set up drawing context
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        // Set up face detection options
        const faceDetectionOptions = new faceLandmarksDetection.FaceDetectionOptions(
          {
            enableFaceExpressions: true,
          }
        );

        // Continuously detect faces and expressions
        setInterval(async () => {
          // Draw video frame onto canvas
          context.drawImage(video, 0, 0, canvas.width, canvas.height);

          // Detect faces in canvas
          const faces = await faceLandmarksModel.estimateFaces({
            input: canvas,
            faceDetectionOptions,
          });

          // Check if any faces were detected
          if (faces.length > 0) {
            // Get the first detected face and its expression
            const face = faces[0];
            const expressions = await faceExpressionModel.predictExpressions(
              faceLandmarksModel,
              face.scaledMesh
            );

            // Find the highest-scoring expression
            let expression = "No expression detected";
            let maxScore = 0;
            Object.entries(expressions).forEach(([key, value]) => {
              if (value > maxScore) {
                expression = key;
                maxScore = value;
              }
            });

            // Update expression display
            const expressionDisplay = document.getElementById("expression");
            expressionDisplay.textContent = `Detected expression: ${expression}`;
          }
        }, 100);
      });
    </script>
  </body>
</html>
